<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Booking - Jaipur Taxi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #27ae60;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-content {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e1e5e9;
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .sidebar-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .booking-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .booking-info h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .info-value {
            color: #2c3e50;
            font-weight: 600;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-accepted {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-started {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .driver-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .driver-info h5 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .driver-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .driver-details:last-child {
            margin-bottom: 0;
        }
        
        .no-booking {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }
        
        .no-booking h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .control-btn:hover {
            background: #5a6fd8;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó Track Your Booking</h1>
        <div class="status-indicator">
            <div class="status-dot" id="connectionStatus"></div>
            <span id="connectionText">Connecting...</span>
        </div>
    </div>
    
    <div class="main-content">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>üìã Enter Booking ID</h3>
                <form id="trackingForm">
                    <div class="form-group">
                        <label for="bookingId">Booking ID</label>
                        <input type="text" id="bookingId" placeholder="Enter your booking ID" required>
                    </div>
                    <button type="submit" class="btn" id="trackBtn">Track Booking</button>
                </form>
            </div>
            
            <div id="bookingDetails" class="sidebar-section" style="display: none;">
                <h3>üìã Booking Details</h3>
                <div id="bookingInfo"></div>
            </div>
            
            <div id="driverDetails" class="sidebar-section" style="display: none;">
                <h3>üöó Driver Details</h3>
                <div id="driverInfo"></div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="control-btn" onclick="centerOnJaipur()">üìç Jaipur</button>
                <button class="control-btn" onclick="fitToDriver()">üîç Find Driver</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io("http://localhost:3001");
        const map = L.map("map").setView([26.9124, 75.7873], 12); // Jaipur coordinates
        
        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "¬© OpenStreetMap contributors"
        }).addTo(map);
        
        // Store markers and data
        let driverMarker = null;
        let customerMarker = null;
        let currentBooking = null;
        let isTracking = false;
        
        // UI elements
        const connectionStatus = document.getElementById("connectionStatus");
        const connectionText = document.getElementById("connectionText");
        const trackingForm = document.getElementById("trackingForm");
        const bookingIdInput = document.getElementById("bookingId");
        const trackBtn = document.getElementById("trackBtn");
        const bookingDetails = document.getElementById("bookingDetails");
        const bookingInfo = document.getElementById("bookingInfo");
        const driverDetails = document.getElementById("driverDetails");
        const driverInfo = document.getElementById("driverInfo");
        
        // Socket connection events
        socket.on("connect", () => {
            console.log("Connected to server");
            connectionStatus.classList.add("connected");
            connectionText.textContent = "Connected";
        });
        
        socket.on("disconnect", () => {
            console.log("Disconnected from server");
            connectionStatus.classList.remove("connected");
            connectionText.textContent = "Disconnected";
        });
        
        // Receive booking status
        socket.on("booking:status", (data) => {
            console.log("Booking status received:", data);
            updateBookingInfo(data);
        });
        
        // Receive live location updates
        socket.on("location:live", (data) => {
            if (!isTracking || !currentBooking) return;
            
            console.log("Location update:", data);
            updateDriverLocation(data);
        });
        
        // Receive booking updates
        socket.on("booking:accepted", (data) => {
            if (data.booking_id === currentBooking?.booking_id) {
                updateBookingStatus("accepted");
            }
        });
        
        socket.on("trip:started", (data) => {
            if (data.booking_id === currentBooking?.booking_id) {
                updateBookingStatus("started");
            }
        });
        
        socket.on("trip:completed", (data) => {
            if (data.booking_id === currentBooking?.booking_id) {
                updateBookingStatus("completed");
                stopTracking();
            }
        });
        
        // Form submission
        trackingForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const bookingId = bookingIdInput.value.trim();
            
            if (bookingId) {
                startTracking(bookingId);
            }
        });
        
        function startTracking(bookingId) {
            if (isTracking) {
                stopTracking();
            }
            
            trackBtn.textContent = "Tracking...";
            trackBtn.disabled = true;
            
            // Join as customer to track specific booking
            socket.emit("customer:join", {
                booking_id: bookingId,
                customer_id: "customer_" + Date.now()
            });
            
            currentBooking = { booking_id: bookingId };
            isTracking = true;
            
            // Show booking details section
            bookingDetails.style.display = "block";
            driverDetails.style.display = "block";
            
            // Show initial booking info
            bookingInfo.innerHTML = `
                <div class="booking-info">
                    <h4>Booking #${bookingId}</h4>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge status-pending">Searching...</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Driver:</span>
                        <span class="info-value">Not assigned yet</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vehicle:</span>
                        <span class="info-value">--</span>
                    </div>
                </div>
            `;
            
            driverInfo.innerHTML = `
                <div class="no-booking">
                    <h3>No driver assigned yet</h3>
                    <p>We're searching for the nearest available driver...</p>
                </div>
            `;
        }
        
        function stopTracking() {
            isTracking = false;
            trackBtn.textContent = "Track Booking";
            trackBtn.disabled = false;
            
            if (driverMarker) {
                map.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            if (customerMarker) {
                map.removeLayer(customerMarker);
                customerMarker = null;
            }
            
            currentBooking = null;
        }
        
        function updateBookingInfo(data) {
            currentBooking = data;
            
            const statusClass = `status-${data.status || 'pending'}`;
            const statusText = data.status || 'Searching...';
            
            bookingInfo.innerHTML = `
                <div class="booking-info">
                    <h4>Booking #${data.booking_id}</h4>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Driver:</span>
                        <span class="info-value">${data.driver_id || 'Not assigned yet'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Vehicle:</span>
                        <span class="info-value">${data.vehicle_id || '--'}</span>
                    </div>
                </div>
            `;
            
            if (data.driver_id) {
                driverInfo.innerHTML = `
                    <div class="driver-info">
                        <h5>üöó Your Driver</h5>
                        <div class="driver-details">
                            <span class="info-label">Driver ID:</span>
                            <span class="info-value">${data.driver_id}</span>
                        </div>
                        <div class="driver-details">
                            <span class="info-label">Vehicle:</span>
                            <span class="info-value">${data.vehicle_id}</span>
                        </div>
                        <div class="driver-details">
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateDriverLocation(data) {
            if (data.booking_id !== currentBooking?.booking_id) return;
            
            const { lat, lon, driver_id, vehicle_id } = data;
            
            if (driverMarker) {
                // Update existing marker
                driverMarker.setLatLng([lat, lon]);
                driverMarker.setPopupContent(`
                    <strong>üöó Your Driver</strong><br>
                    Driver: ${driver_id}<br>
                    Vehicle: ${vehicle_id}<br>
                    Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>
                    Time: ${new Date().toLocaleTimeString()}
                `);
            } else {
                // Create new marker
                driverMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'driver-marker',
                        html: '<div style="background: #e74c3c; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 14px;">üöó</div>',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                driverMarker.bindPopup(`
                    <strong>üöó Your Driver</strong><br>
                    Driver: ${driver_id}<br>
                    Vehicle: ${vehicle_id}<br>
                    Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}<br>
                    Time: ${new Date().toLocaleTimeString()}
                `);
                
                // Center map on driver
                map.setView([lat, lon], 15);
            }
        }
        
        function updateBookingStatus(status) {
            const statusElement = document.querySelector('.status-badge');
            if (statusElement) {
                statusElement.className = `status-badge status-${status}`;
                statusElement.textContent = status;
            }
        }
        
        function centerOnJaipur() {
            map.setView([26.9124, 75.7873], 12);
        }
        
        function fitToDriver() {
            if (driverMarker) {
                map.setView(driverMarker.getLatLng(), 15);
                driverMarker.openPopup();
            } else {
                centerOnJaipur();
            }
        }
        
        // Initialize
        centerOnJaipur();
    </script>
</body>
</html>
